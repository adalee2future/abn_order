---
output:
  html_document:
    css: style.css
  pdf_document:
    latex_engine: xelatex
  word_document: default
params:
  rpt_date: '20170401'
---

---
locale: `r Sys.setlocale(locale="zh_CN.UTF-8")`
title: `r paste0("异常交易监控日报", substr(params$rpt_date, 5, 8))`
---

```{r echo=FALSE, warning=FALSE, message=FALSE}
# import pacakges
library(ggplot2)
library(plotly)
library(scales)
library(dplyr)
library(tidyr)
#library(xlsx)

# fixed value
ZJ_XJ <- c("增加", "下降")
GY_DY <- c("高于", "低于")
LANTERN_FESTIVAL_DAY <- as.Date("2017-02-11") #元宵节
APOLLO_ACCIDENT_DAY <- as.Date("2017-03-23") #阿波罗事故日
# colors
total_order_color <- '#228B22' # Forest Green
payed_order_color <- '#929f36' # another green
abn1_color <- '#EAB656' #'#FFA500' # Orange
abn1_ydnorm_color <- '#E8E84A' #'#FFFF00' # Yellow
abn2_color <- '#0000FF' # Blue
abn2_chaoshi_color <- '#00BFFF' # Deep Sky Blue
abn3_color <- '#B22929' # '#FF0000' # Red
abn5_color <- '#A023A0'  #'#800080' # purple
  
# udf
## format decimal to percentage
percent <- function(x, digits = 2, format = "f", ...) {
  paste0(formatC(100 * x, format = format, digits = digits, ...), "%")
}
## decide color of some text
text_color <- function(diff.val, diff.sd, reverse=TRUE) {
  if (abs(diff.sd) < 2) { return("") }
  
  if (reverse) {
    ifelse(diff.val > 0, "color:red", "color:green")
  } else {
    ifelse(diff.val > 0, "color:green", "color:red")
    }
}
## decide if it is appollo accident day
date_desc <- function(d) {
  desc <- "日期: "
  if (d == APOLLO_ACCIDENT_DAY) { desc <- "阿波罗事故日: " }
  if (d == LANTERN_FESTIVAL_DAY) { desc <- "元宵节: " }
  desc
}

# log base breaks
base_breaks <- function(n = 10){
    function(x) {
        axisTicks(log10(range(x, na.rm = TRUE)), log = TRUE, n = n)
    }
}

## decide up or down
decide_up_down <- function(diff.val, updown=ZJ_XJ) {
  ifelse(diff.val >= 0, updown[1], updown[2])
}

# don't show number in scientific form
options(scipen=999)

#xlsx_file <- paste0("data/", params$rpt_date, ".xlsx")
csv_file <- paste0("data/", params$rpt_date, ".csv")


#abn_daily <- read.xlsx(xlsx_file, 1)
abn_daily <- read.csv(csv_file, colClasses=
                        c("character", "factor", "factor", "factor", "integer", "numeric", "numeric"))
# order_date to Date
abn_daily <- abn_daily %>% mutate(order_date=as.Date(order_date))
# order by order_date and abn
abn_daily <- abn_daily[order(abn_daily$order_date, abn_daily$abn), ]

# some special date
today <- max(abn_daily$order_date)
yesterday <- today -1
start_date <- today - 30
date_range <- paste0("(", format(min(abn_daily$order_date), "%m%d"),
                 "-", format(max(abn_daily$order_date), "%m%d"), ")")

# fix wrong data, abn1-ydnorm for today is not correct, use mean of 7 days to replace
abn1_ydnorm_respb_scenes <- unique(as.character(abn_daily[abn_daily$order_date == today &
                                        abn_daily$abn == "abn1-ydnorm",]$respb_scene))
abn_7_days_abn1_ydnorm_avg <- data.frame(abn_daily %>%
  filter(order_date >= yesterday - 7 & order_date <= yesterday &
           abn == "abn1-ydnorm" & respb_scene %in% abn1_ydnorm_respb_scenes) %>%
  group_by(respb_scene, respb_scene_name) %>%
  summarize(actualcnt=round(mean(actualcnt)), cnt=mean(cnt), ratio_payed=mean(ratio_payed)))
abn_daily[abn_daily$order_date == today & abn_daily$abn == "abn1-ydnorm",3:7] <- abn_7_days_abn1_ydnorm_avg
```

## 总订单量背景趋势

```{r echo=FALSE, warning=FALSE, message=FALSE}
abn.30days <- abn_daily %>%
  filter(order_date > start_date & abn %in% c("dlvr_abnormal","abnormal", "bookord", "payed", "created")) %>%
  select(order_date, abn, actualcnt)
 
abn.30days.spread <- spread(abn.30days, abn, actualcnt) %>%
  mutate(payed_rate=payed/created, payed_rate=payed/created, book_rate=bookord/payed, abn_rate=abnormal/payed, dlvr_abnormal_rate=dlvr_abnormal/payed)

abn.30days.summary <- abn.30days.spread %>%
  select(order_date, created, payed_rate, book_rate, abn_rate, dlvr_abnormal_rate) %>%
  group_by(1) %>%
  summarize(mean.created=mean(created), sd.created=sd(created),
            mean.payed.rate=mean(payed_rate), sd.payed.rate=sd(payed_rate),
            mean.book.rate=mean(book_rate), sd.book.rate=sd(book_rate),
            mean.abn.rate=mean(abn_rate), sd.abn.rate=sd(abn_rate),
            mean.dlvr_abnormal.rate=mean(dlvr_abnormal_rate), sd.dlvr_abnormal.rate=sd(dlvr_abnormal_rate))
abn.today <- abn.30days.spread %>% filter(order_date == today)
abn.yesterday <- abn.30days.spread %>% filter(order_date == yesterday)

# 创建订单量
created.diff.yesterday <- abn.today$created - abn.yesterday$created
created.diff.avg <- abn.today$created - abn.30days.summary$mean.created
created.diff.sd <- created.diff.avg / abn.30days.summary$sd.created
# 支付订单量
payed_rate.diff.yesterday <- abn.today$payed_rate-abn.yesterday$payed_rate
payed_rate.diff.avg <- abn.today$payed_rate-abn.30days.summary$mean.payed.rate
payed_rate.diff.sd <- payed_rate.diff.avg/abn.30days.summary$sd.payed.rate
# 预定单
book_rate.diff.yesterday <- abn.today$book_rate - abn.yesterday$book_rate
book_rate.diff.avg <- abn.today$book_rate - abn.30days.summary$mean.book.rate
book_rate.diff.sd <- book_rate.diff.avg / abn.30days.summary$sd.book.rate
# 订单取消
abn_rate.diff.yesterday <- abn.today$abn_rate - abn.yesterday$abn_rate
abn_rate.diff.avg <- abn.today$abn_rate-abn.30days.summary$mean.abn.rate
abn_rate.diff.sd <- abn_rate.diff.avg/abn.30days.summary$sd.abn.rate
# 运单异常或超时
dlvr_abnormal_rate.diff.yesterday <- abn.today$dlvr_abnormal_rate - abn.yesterday$dlvr_abnormal_rate
dlvr_abnormal_rate.diff.avg <- abn.today$dlvr_abnormal_rate-abn.30days.summary$mean.dlvr_abnormal.rate
dlvr_abnormal_rate.diff.sd <- dlvr_abnormal_rate.diff.avg/abn.30days.summary$sd.dlvr_abnormal.rate
```

####【创建订单】

* 本日订单量 `r prettyNum(abn.today$created, big.mark=",")` 单，比前一天`r decide_up_down(created.diff.yesterday)` `r prettyNum(abs(created.diff.yesterday), big.mark=",")`单，<span style="`r text_color(created.diff.avg, created.diff.sd, reverse=FALSE)`">`r decide_up_down(created.diff.avg, GY_DY)`30天内均值`r prettyNum(abs(round(created.diff.avg)), big.mark=",")`
单(`r round(abs(created.diff.sd), 2)`倍标准差)</span>
* 30天内均值为 `r prettyNum(abn.30days.summary$mean.created, big.mark=",")` ，标准差为 `r prettyNum(round(abn.30days.summary$sd.created), big.mark=",")`

####【支付订单】

* 本日订单量 `r prettyNum(abn.today$payed, big.mark=",")` 单，占创建订单量`r percent(abn.today$payed_rate ,digits=2)`，比前一天`r decide_up_down(payed_rate.diff.yesterday)``r round((abs(payed_rate.diff.yesterday)) * 100, 2)`个百分点，<span style="`r text_color(payed_rate.diff.avg, payed_rate.diff.sd, reverse=FALSE)`">`r decide_up_down(payed_rate.diff.avg, GY_DY)`30天内均值`r round((abs(payed_rate.diff.avg))*100, 1)`个百分点(`r round(abs(payed_rate.diff.sd), 2)`倍标准差)</span>
* 订单支付率30天内均值为 `r percent(abn.30days.summary$mean.payed.rate)`，标准差为 `r percent(abn.30days.summary$sd.payed.rate)`

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.height=4, fig.width=8}
abn_ratio <- abn_daily %>%
  filter(respb_scene == "_汇总" & abn %in% c("abn1", "abn1-ydnorm", "abn3","abn5")) %>%
  group_by(order_date) %>%
  summarize(abn_ratio=sum(ratio_payed))

dlvr_abnormal_ratio <- abn_daily %>%
  filter(respb_scene == "_汇总" & abn %in% c("abn2", "abn2-chaoshi")) %>%
  group_by(order_date) %>%
  summarize(dlvr_abnormal_ratio=sum(ratio_payed))
  
abn_payed_ratio <- abn_daily %>%
  filter(abn=="payed") %>%
  select(order_date, ratio_payed)

abn_created_cnt <- abn_daily %>%
  filter(abn=="created") %>%
  select(order_date, actualcnt)

abn_payed_cnt <- abn_daily %>%
  filter(abn=="payed") %>%
  mutate(payed_actualcnt=actualcnt) %>%
  select(order_date, payed_actualcnt)

temp <-merge(x=abn_ratio, y=abn_payed_ratio)
temp <- merge(x=temp, y=dlvr_abnormal_ratio)
temp <- merge(x=temp, y=abn_created_cnt)
abn_overall <- merge(x=temp, y=abn_payed_cnt)

abn_overall <- abn_overall %>%
  mutate(abn_cnt=abn_ratio*actualcnt*ratio_payed/10000,
         dlvr_abnormal_cnt=dlvr_abnormal_ratio*actualcnt*ratio_payed/10000,
         order_date=as.Date(order_date))

abn_total_cnt <- abn_overall %>%
  mutate(type="created", value=actualcnt) %>%
  select(order_date, value, type)

abn_payed_cnt <- abn_overall %>%
  mutate(type="payed", value=payed_actualcnt) %>%
  select(order_date, value, type)

abn_cnt <- abn_overall %>%
  mutate(value=abn_cnt) %>%
  mutate(type="abn") %>%
  select(order_date, value, type)

dlvr_abnormal_cnt <- abn_overall %>%
  mutate(value=dlvr_abnormal_cnt) %>%
  mutate(type="dlvr_abnormal") %>%
  select(order_date, value, type)

abn_total_abn_cnt <- rbind(abn_total_cnt, abn_cnt, dlvr_abnormal_cnt)
abn_total_abn_cnt$type <- as.factor(abn_total_abn_cnt$type)
levels(abn_total_abn_cnt$type) <- list("创建订单量"="created", 
                                       "总异常订单量"="abn",
                                       "低质量订单量"="dlvr_abnormal")


abn_total_and_payed_cnt <- rbind(abn_total_cnt,abn_payed_cnt)
abn_total_and_payed_cnt$type <- as.factor(abn_total_and_payed_cnt$type)
levels(abn_total_and_payed_cnt$type) <- list("创建订单量"="created",
                                        "支付订单量"="payed")
p1 <- ggplot(abn_total_and_payed_cnt, aes(x=order_date, y=value, color=type)) +
  geom_line() +
  theme(text = element_text('SimSun'), legend.title=element_blank()) +
  labs(x = "日期", y = "订单量") +
  scale_x_date(breaks = pretty_breaks(15), labels = date_format("%m/%d")) +
  ggtitle(paste("创建与支付订单量趋势", date_range)) +
  scale_color_manual(breaks=c("创建订单量", "支付订单量"),
                    values=c(total_order_color, payed_order_color)) +
        ylim(0, max(abn_total_and_payed_cnt$value)*1.1) +
  scale_y_continuous(labels=function(x){prettyNum(x, big.mark=",")})
  

p1 <- plotly_build(p1)
p1$x$data[[1]]$text <-
  apply(abn_total_cnt, 1,
        function(item){
         paste0(date_desc(item[1]), item[1], "<br>创建订单量: ", prettyNum(item[2], big.mark = ","))
          }
        )
p1$x$data[[2]]$text <-
  apply(abn_payed_cnt, 1,
        function(item){
         paste0(date_desc(item[1]), item[1], "<br>支付订单量: ", prettyNum(item[2], big.mark = ","))
          }
        )
p1

```

####【预定单】

* 本日订单量 `r prettyNum(abn.today$bookord, big.mark=",")` 单，占支付订单量`r percent(abn.today$book_rate)`，比前一天`r decide_up_down(book_rate.diff.yesterday)``r round(abs(book_rate.diff.yesterday*100), 2)`个百分点，<span style="`r text_color(book_rate.diff.avg, book_rate.diff.sd, reverse=FALSE)`">`r decide_up_down(book_rate.diff.avg, GY_DY)`30天内均值`r round((abs(book_rate.diff.avg))*100, 2)`个百分点(`r round(abs(book_rate.diff.sd), 2)`倍标准差)</span>
* 订单预订率30天内均值为 `r percent(abn.30days.summary$mean.book.rate)`，标准差为 `r percent(abn.30days.summary$sd.book.rate)`

####【异常订单】

* 本日订单量 `r prettyNum(abn.today$abnormal, big.mark=",")`单，占支付订单量`r percent(abn.today$abn_rate)`，比前一天`r decide_up_down(abn_rate.diff.yesterday)``r round(abs(abn_rate.diff.yesterday)*100, digits=2)`个百分 点，<span style="`r text_color(abn_rate.diff.avg, abn_rate.diff.sd)`">`r decide_up_down(abn_rate.diff.avg, GY_DY)`30天内均值`r round((abs(abn_rate.diff.avg))*100,2)`个百分点(`r round(abs(abn_rate.diff.sd), 2)`倍标准差)</span>
* 订单异常率30天内均值为 `r percent(abn.30days.summary$mean.abn.rate)`，标准差为 `r percent(abn.30days.summary$sd.abn.rate)`

```{r echo=FALSE, warning=FALSE, message=FALSE, results="hide"}
today_overall <- subset(abn_daily, order_date==today & respb_scene == "_汇总" &
                          abn %in% c("abn1", "abn1-ydnorm", "abn3","abn5"))
today_overall$abn <- droplevels(today_overall$abn) # remove unused levels
today_overall <- today_overall[order(today_overall$abn), ]
levels(today_overall$abn) <- list("订单取消_运单异常"="abn1",
                                    "订单取消_运单正常"="abn1-ydnorm",
                                    "订单取消_无运单"="abn3",
                                     "退订单"="abn5")
today_overall$percent <- today_overall$actualcnt / sum(today_overall$actualcnt)
bp<- ggplot(today_overall, aes(x="", y=percent, fill=abn)) +
  geom_bar(width = 1, stat = "identity") +
  theme(text = element_text(family = 'SimSun'),
        axis.ticks=element_blank(),
        legend.title=element_blank()) +
  ggtitle("异常订单占比") +
  guides(fill=guide_legend(title=NULL)) +
  labs(x="", y="") +
  scale_fill_manual(breaks=c("订单取消_运单异常",
                             "订单取消_运单正常",
                             "订单取消_无运单",
                             "退订单"),
                      values=c(abn1_color,
                               abn1_ydnorm_color,
                               abn3_color,
                               abn5_color))
scale_color_manual(breaks=c("订单异常率", "订单低质量率"),
                   values=c("#A52A2A", "#6495ED"))
```

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.height=3}
pie <- bp + coord_polar("y", start=0)
midpoint <- cumsum(rev(today_overall$percent)) - rev(today_overall$percent)/2
labels <- percent(rev(today_overall$percent), digits=2)
#labels[4] <- percent(rev(today_overall$percent)[4], digits=2)
pie <- pie + scale_y_continuous(breaks=midpoint, labels=labels)
pie + theme(panel.background = element_blank()) 
```

####【低质量订单（运单异常&超时）】

* 本日订单量 `r prettyNum(abn.today$dlvr_abnormal, big.mark=",")`单，占支付订单量`r percent(abn.today$dlvr_abnormal_rate)`，比前一天`r decide_up_down(dlvr_abnormal_rate.diff.yesterday)``r round(abs(dlvr_abnormal_rate.diff.yesterday)*100, digits=2)`个百分 点，<span style="`r text_color(dlvr_abnormal_rate.diff.avg, dlvr_abnormal_rate.diff.sd)`">`r decide_up_down(dlvr_abnormal_rate.diff.avg, GY_DY)`30天内均值`r round((abs(dlvr_abnormal_rate.diff.avg))*100,2)`个百分点(`r round(abs(dlvr_abnormal_rate.diff.sd), 2)`倍标准差)</span>
* 订单低质量率30天内均值为 `r percent(abn.30days.summary$mean.dlvr_abnormal.rate)`，标准差为 `r percent(abn.30days.summary$sd.dlvr_abnormal.rate)`
<br><br/>


```{r echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
abn_total_abn_abn_ratio <- abn_overall %>% 
  mutate(type="订单异常率", ratio=abn_ratio) %>%
  select(order_date, ratio, type)

abn_total_abn_delivery_ratio <- abn_overall %>% 
  mutate(type="订单低质量率", ratio=dlvr_abnormal_ratio) %>%
  select(order_date, ratio, type)

abn_total_abn_ratio <- rbind(abn_total_abn_abn_ratio, abn_total_abn_delivery_ratio)
abn_total_abn_ratio$type <- factor(abn_total_abn_ratio$type, levels=c("订单异常率", "订单低质量率"))
max_y <- ceiling(max(abn_total_abn_ratio$ratio) * 1.15)
p2 <- ggplot(abn_total_abn_ratio, aes(x=order_date, y=ratio, color=type)) +
  geom_line() +
  theme(text = element_text('SimSun'), legend.title=element_blank()) +
  labs(x = "日期", y = "百分率") +
  scale_x_date(breaks = pretty_breaks(15), labels = date_format("%m/%d")) +
  ggtitle(paste("订单异常与低质量率趋势", date_range)) +
  scale_color_manual(breaks=c("订单异常率", "订单低质量率"),
                    values=c("#A52A2A", "#6495ED")) + 
  scale_y_continuous(labels=function(x){paste0(x,"%")})
```

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.height=4, fig.width=8}
p2 <- plotly_build(p2)
p2$x$data[[1]]$text <-
  apply(abn_total_abn_abn_ratio, 1,
        function(item){
         paste0(date_desc(item[1]), item[1], "<br>订单异常率: ", round(as.double(item[2]),2), "%")
          }
        )
p2$x$data[[2]]$text <-
  apply(abn_total_abn_delivery_ratio, 1,
        function(item){
         paste0(date_desc(item[1]), item[1], "<br>订单低质量率: ", round(as.double(item[2]),2), "%")
          }
        )
p2
```

## 异常摘要

```{r echo=FALSE, warning=FALSE, message=FALSE}
abn.30days.detail <- abn_daily %>%
  filter(order_date > start_date & respb_scene == "_汇总") %>%
  select(order_date, abn, ratio_payed)

abn.30days.detail.spread <- spread(abn.30days.detail, abn, ratio_payed)
abn.30days.detail.summary <- abn.30days.detail.spread %>%
  group_by(1) %>%
  summarize(mean.abn1=mean(abn1), sd.abn1=sd(abn1),
            mean.abn1_ydnorm=mean(`abn1-ydnorm`), sd.abn1_ydnorm=sd(`abn1-ydnorm`),
            mean.abn2=mean(abn2), sd.abn2=sd(abn2),
            mean.abn2_chaoshi=mean(`abn2-chaoshi`), sd.abn2_chaoshi=sd(`abn2-chaoshi`),
            mean.abn3=mean(abn3), sd.abn3=sd(abn3),
            mean.abn5=mean(abn5), sd.abn5=sd(abn5))

abn.today.detail.actualcnt <- abn_daily %>%
  filter(order_date == today & respb_scene == "_汇总") %>%
  select(abn, actualcnt)
abn.today.detail.actualcnt.spread <- spread(abn.today.detail.actualcnt, abn, actualcnt)

abn.today.detail.cnt <- abn_daily %>%
  filter(order_date == today & respb_scene == "_汇总") %>%
  select(abn, cnt)
abn.today.detail.cnt.spread <- spread(abn.today.detail.cnt, abn, cnt)

abn.yesterday.detail.actualcnt <- abn_daily %>%
  filter(order_date == yesterday & respb_scene == "_汇总") %>%
  select(abn, actualcnt)
abn.yesterday.detail.actualcnt.spread <- spread(abn.yesterday.detail.actualcnt, abn, actualcnt)

abn.yesterday.detail.cnt <- abn_daily %>%
  filter(order_date == yesterday & respb_scene == "_汇总") %>%
  select(abn, ratio_payed)
abn.yesterday.detail.cnt.spread <- spread(abn.yesterday.detail.cnt, abn, ratio_payed)

# 订单正常运单超时 (abn2-chaoshi)
abn2.chaoshi.diff.yesterday <- abn.today.detail.cnt.spread[["abn2-chaoshi"]] - abn.yesterday.detail.cnt.spread[["abn2-chaoshi"]]
abn2.chaoshi.diff.avg <- abn.today.detail.cnt.spread[["abn2-chaoshi"]] - abn.30days.detail.summary$mean.abn2_chaoshi
abn2.chaoshi.diff.sd <- abn2.chaoshi.diff.avg / abn.30days.detail.summary$sd.abn2_chaoshi

# 订单正常运单异常 (abn2)
abn2.diff.yesterday <- abn.today.detail.cnt.spread[["abn2"]] - abn.yesterday.detail.cnt.spread[["abn2"]]
abn2.diff.avg <- abn.today.detail.cnt.spread[["abn2"]] - abn.30days.detail.summary$mean.abn2
abn2.diff.sd <- abn2.diff.avg / abn.30days.detail.summary$sd.abn2

# 订单取消无运单 (abn3)
abn3.diff.yesterday <- abn.today.detail.cnt.spread[["abn3"]] - abn.yesterday.detail.cnt.spread[["abn3"]]
abn3.diff.avg <- abn.today.detail.cnt.spread[["abn3"]] - abn.30days.detail.summary$mean.abn3
abn3.diff.sd <- abn3.diff.avg / abn.30days.detail.summary$sd.abn3

# 订单取消运单异常 (abn1)
abn1.diff.yesterday <- abn.today.detail.cnt.spread[["abn1"]] - abn.yesterday.detail.cnt.spread[["abn1"]]
abn1.diff.avg <- abn.today.detail.cnt.spread[["abn1"]] - abn.30days.detail.summary$mean.abn1
abn1.diff.sd <- abn1.diff.avg / abn.30days.detail.summary$sd.abn1

# 订单取消运单正常 (abn1-ydnorm)
abn1.ydnorm.diff.yesterday <- abn.today.detail.cnt.spread[["abn1-ydnorm"]] - abn.yesterday.detail.cnt.spread[["abn1-ydnorm"]]
abn1.ydnorm.diff.avg <- abn.today.detail.cnt.spread[["abn1-ydnorm"]] - abn.30days.detail.summary$mean.abn1_ydnorm
abn1.ydnorm.diff.sd <- abn1.ydnorm.diff.avg / abn.30days.detail.summary$sd.abn1_ydnorm

# 退单 (abn5)
abn5.diff.yesterday <- abn.today.detail.cnt.spread[["abn5"]] - abn.yesterday.detail.cnt.spread[["abn5"]]
abn5.diff.avg <- abn.today.detail.cnt.spread[["abn5"]] - abn.30days.detail.summary$mean.abn5
abn5.diff.sd <- abn5.diff.avg / abn.30days.detail.summary$sd.abn5
```

#### 【订单取消无运单】

* 本日订单量 `r prettyNum(abn.today.detail.actualcnt.spread[["abn3"]], big.mark=",")`单，占支付订单量`r round(abn.today.detail.cnt.spread[["abn3"]], 2)`%，比前一天`r decide_up_down(abn3.diff.yesterday)``r round(abs(abn3.diff.yesterday), 2)`个百分点，<span style="`r text_color(abn3.diff.avg, abn3.diff.sd)`">`r decide_up_down(abn3.diff.avg, GY_DY)`30天内均值`r round(abs(abn3.diff.avg), 2)`个百分点(`r round(abs(abn3.diff.sd), 3)`倍标准差)</span>
* 30天内均值为 `r round(abn.30days.detail.summary$mean.abn3,2)`%，标准差为 `r round(abn.30days.detail.summary$sd.abn3, 3)`%

#### 【订单取消运单异常】

* 本日订单量 `r prettyNum(abn.today.detail.actualcnt.spread[["abn1"]], big.mark=",")`单，占支付订单量`r round(abn.today.detail.cnt.spread[["abn1"]], 2)`%，比前一天`r decide_up_down(abn1.diff.yesterday)``r round(abs(abn1.diff.yesterday), 2)`个百分点，<span style="`r text_color(abn1.diff.avg, abn1.diff.sd)`">`r decide_up_down(abn1.diff.avg, GY_DY)`30天内均值`r round(abs(abn1.diff.avg), 2)`个百分点(`r round(abs(abn1.diff.sd), 2)`倍标准差)</span>
* 30天内均值为 `r round(abn.30days.detail.summary$mean.abn1,3)`%，标准差为 `r round(abn.30days.detail.summary$sd.abn1, 3)`%

#### 【退款单】

* 本日订单量 `r prettyNum(abn.today.detail.actualcnt.spread[["abn5"]], big.mark=",")`单，占支付订单量`r round(abn.today.detail.cnt.spread[["abn5"]], 2)`%，比前一天`r decide_up_down(abn5.diff.yesterday)``r round(abs(abn5.diff.yesterday), 2)`个百分点，<span style="`r text_color(abn5.diff.avg, abn5.diff.sd)`">`r decide_up_down(abn5.diff.avg, GY_DY)`30天内均值`r round(abs(abn5.diff.avg), 2)`个百分点(`r round(abs(abn5.diff.sd), 2)`倍标准差)</span>
* 30天内均值为 `r round(abn.30days.detail.summary$mean.abn5,3)`%，标准差为 `r round(abn.30days.detail.summary$sd.abn5, 3)`%

#### 【订单取消运单正常】

* 本日订单量 `r prettyNum(abn.today.detail.actualcnt.spread[["abn1-ydnorm"]], big.mark=",")`单，占支付订单量`r round(abn.today.detail.cnt.spread[["abn1-ydnorm"]], 3)`%，比前一天`r decide_up_down(abn1.ydnorm.diff.yesterday)``r round(abs(abn1.ydnorm.diff.yesterday), 3)`个百分点，<span style="`r text_color(abn1.ydnorm.diff.avg, abn1.ydnorm.diff.sd)`">`r decide_up_down(abn1.ydnorm.diff.avg, GY_DY)`30天内均值`r round(abs(abn1.ydnorm.diff.avg), 3)`个百分点(`r round(abs(abn1.ydnorm.diff.sd), 2)`倍标准差)</span>
* 30天内均值为 `r round(abn.30days.detail.summary$mean.abn1_ydnorm,3)`%，标准差为 `r round(abn.30days.detail.summary$sd.abn1_ydnorm, 3)`%

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.height=4,fig.width=8}

# plot 1
p1 <- ggplot(subset(abn_daily, abn=="created"), aes(x=order_date, y=actualcnt)) +
  geom_area(alpha = 0.4, position = 'identity', aes(fill = "创建订单量")) + theme(legend.position = "bottom", legend.title = element_blank(), text = element_text('SimSun'), legend.text=element_text(size=8), plot.margin=unit(c(1,1.2,1.2,1.2),"cm")) + labs(x = "日期", y = "数量") + scale_y_continuous(labels = comma) + scale_x_date(breaks = pretty_breaks(15), labels = date_format("%m/%d")) + scale_fill_manual(values=total_order_color)

# plot2
abn_rate <- abn_daily %>%
  filter(respb_scene == "_汇总") %>%
  mutate(value=ratio_payed, abn=droplevels(abn)) # remove unused levels

abn_rate_135 <- abn_rate %>%
  filter(abn %in% c("abn1", "abn1-ydnorm", "abn3", "abn5")) %>%
  mutate(abn=droplevels(abn), value=value/100)

levels(abn_rate_135$abn) <- list("订单取消_无运单"="abn3",
                                 "订单取消_运单异常"="abn1",
                                 "退单"="abn5",
                                 "订单取消_运单正常"="abn1-ydnorm")
abn_rate_135 <- abn_rate_135[order(abn_rate_135$order_date), ]
p2 <- ggplot(abn_rate_135, aes(x=order_date,y=value)) +
  geom_line(aes(y = value, colour = abn)) +
  ggtitle(paste("订单异常率变化趋势", date_range)) +
  scale_color_manual(breaks=c("订单取消_无运单",
                              "订单取消_运单异常",
                              "退单",
                              "订单取消_运单正常"),
                     values=c(abn3_color,
                              abn1_color,
                              abn5_color,
                              abn1_ydnorm_color
                              )) +
  theme(text = element_text('SimSun'),
        legend.text=element_text(size=8),
        legend.title=element_blank()) +
  scale_y_continuous(trans="log10", breaks = base_breaks(), labels=function(x){percent(x,digits=3)}) +
  xlab("日期") + ylab("异常率")


p2 <- plotly::plotly_build(p2)
p2$x$data[[1]]$text <-
  apply(abn_rate_135 %>% filter(abn == "订单取消_无运单"), 1,
        function(item){
         paste0(date_desc(item[1]), item[1], "<br>订单取消_无运单: ", round(as.double(item[7]),4), "%")
          }
        )
p2$x$data[[2]]$text <-
  apply(abn_rate_135 %>% filter(abn == "订单取消_运单异常"), 1,
        function(item){
         paste0(date_desc(item[1]), item[1], "<br>订单取消_运单异常: ", round(as.double(item[7]),4), "%")
          }
        )
p2$x$data[[3]]$text <-
  apply(abn_rate_135 %>% filter(abn == "退单"), 1,
        function(item){
         paste0(date_desc(item[1]), item[1], "<br>退单: ", round(as.double(item[7]),4), "%")
          }
        )
p2$x$data[[4]]$text <-
  apply(abn_rate_135 %>% filter(abn == "订单取消_运单正常"), 1,
        function(item){
         paste0(date_desc(item[1]), item[1], "<br>订单取消_运单正常: ", round(as.double(item[7]),4), "%")
          }
        )
p2
```

## 低质量订单（运单异常或超时）摘要

#### 【订单正常运单超时】

* 本日订单量 `r prettyNum(abn.today.detail.actualcnt.spread[["abn2-chaoshi"]], big.mark=",")`单，占支付订单量`r round(abn.today.detail.cnt.spread[["abn2-chaoshi"]], 2)`%，比前一天`r decide_up_down(abn2.chaoshi.diff.yesterday)``r round(abs(abn2.chaoshi.diff.yesterday), 2)`个百分点，<span style="`r text_color(abn2.chaoshi.diff.avg, abn2.chaoshi.diff.sd)`">`r decide_up_down(abn2.chaoshi.diff.avg, GY_DY)`30天内均值`r round(abs(abn2.chaoshi.diff.avg), 2)`个百分点(`r round(abs(abn2.chaoshi.diff.sd), 2)`倍标准差)</span>
* 30天内均值为 `r round(abn.30days.detail.summary$mean.abn2_chaoshi,3)`%，标准差为 `r round(abn.30days.detail.summary$sd.abn2_chaoshi, 3)`%

#### 【订单正常运单异常】

* 本日订单量 `r prettyNum(abn.today.detail.actualcnt.spread[["abn2"]], big.mark=",")`单，占支付订单量`r round(abn.today.detail.cnt.spread[["abn2"]], 2)`%，比前一天`r decide_up_down(abn2.diff.yesterday)``r round(abs(abn2.diff.yesterday), 2)`个百分点，<span style="`r text_color(abn2.diff.avg, abn2.diff.sd)`">`r decide_up_down(abn2.diff.avg, GY_DY)`30天内均值`r round(abs(abn2.diff.avg), 2)`个百分点(`r round(abs(abn2.diff.sd), 2)`倍标准差)</span>
* 30天内均值为 `r round(abn.30days.detail.summary$mean.abn2,3)`%，标准差为 `r round(abn.30days.detail.summary$sd.abn2, 3)`%


```{r echo=FALSE, warning=FALSE, message=FALSE, fig.height=4,fig.width=8}

# plot2

rate1 <- abn_rate %>%
  filter(abn %in% c("abn2", "abn2-chaoshi")) %>%
  mutate(value=ratio_payed)

abn_scaled_rate <- rate1
abn_scaled_rate$abn <- droplevels(abn_scaled_rate$abn) # remove unused levels
levels(abn_scaled_rate$abn) <- list("订单正常_运单超时"="abn2-chaoshi",
                                    "订单正常_运单异常"="abn2"
                                    )
abn_scaled_rate <- abn_scaled_rate[order(abn_scaled_rate$order_date), ]
p2 <- ggplot(abn_scaled_rate, aes(x=order_date,y=value)) +
  geom_line(aes(y = value, colour = abn)) +
  scale_color_manual(breaks=c("订单正常_运单超时", "订单正常_运单异常"),
                     values=c(abn2_chaoshi_color, abn2_color)) +
  theme(text = element_text('SimSun'),
        legend.text=element_text(size=8),
        legend.title=element_blank()) +
  ylim(0, 10) + xlab("日期") + ylab("百分率") +
  scale_x_date(breaks = pretty_breaks(15), labels = date_format("%m/%d")) +
  ggtitle(paste("订单低质量率变化趋势", date_range)) +
  scale_y_continuous(labels=function(x){paste0(x,"%")})

p2 <- plotly_build(p2)
p2$x$data[[1]]$text <-
  apply(abn_scaled_rate %>% filter(abn == "订单正常_运单超时"), 1,
        function(item){
         paste0(date_desc(item[1]), item[1], "<br>订单正常_运单超时: ", round(as.double(item[7]),2), "%")
          }
        )
p2$x$data[[2]]$text <-
  apply(abn_scaled_rate %>% filter(abn == "订单正常_运单异常"), 1,
        function(item){
         paste0(date_desc(item[1]), item[1], "<br>订单正常_运单异常: ", round(as.double(item[7]),2), "%")
          }
        )
p2
```

## 订单商户取消率 (属于异常订单)

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.height=4,fig.width=8}
# 订单商户取消率变化趋势
## 3-1-1	商户未接单系统取消
## 3-1-2	商户确认前商户拒单
## 3-2-2	运力接单前商户取消
## 1-2-3	运力接单前T内商户取消
abn.shop.cancel.rate <- abn_daily %>%
  filter(respb_scene %in% c("3-2-2", "3-1-1", "3-1-2") | (abn == "abn1" & respb_scene == "1-2-3")) %>%
  mutate(respb_scene=droplevels(respb_scene),
         abn=droplevels(abn),
         respb_scene_name=droplevels(respb_scene_name))

abn.shop.cancel.rate$respb_scene_name <- factor(abn.shop.cancel.rate$respb_scene_name,
                                                levels=c("商户未接单系统取消",
                                                         "商户确认前商户拒单",
                                                         "运力接单前商户取消",
                                                         "运力接单前T内商户取消"))
# 30天数据
abn.shop.cancel.30.days <- abn.shop.cancel.rate %>%
  filter(order_date > start_date) %>%
  select(order_date, respb_scene, ratio_payed)
# 30天数据，列转行
abn.shop.cancel.30.days.spread <- spread(abn.shop.cancel.30.days,
                                         respb_scene,
                                         ratio_payed)
# 今日数据, 订单数
abn.shop.cancel.actualcnt.today <- abn.shop.cancel.rate %>%
  filter(order_date == today) %>%
  select(respb_scene, actualcnt)
# 今日数据, 订单数，列转行
abn.shop.cancel.actualcnt.today.spread <- spread(abn.shop.cancel.actualcnt.today,
                                                 respb_scene, actualcnt)

# 昨日数据, 占比支付订单量
abn.shop.cancel.ratio.yesterday <- abn.shop.cancel.rate %>%
  filter(order_date == yesterday) %>%
  select(respb_scene, ratio_payed)
# 昨日数据, 占比支付订单量，列转行
abn.shop.cancel.ratio.yesterday.spread <- spread(abn.shop.cancel.ratio.yesterday,
                                                     respb_scene, ratio_payed)

# 今日数据, 占比支付订单量
abn.shop.cancel.ratio.today <- abn.shop.cancel.rate %>%
  filter(order_date == today) %>%
  select(respb_scene, ratio_payed)
# 今日数据, 占比支付订单量，列转行
abn.shop.cancel.ratio.today.spread <- spread(abn.shop.cancel.ratio.today,
                                             respb_scene, ratio_payed)

abn.shop.cancel.30.days.spread.summary <- abn.shop.cancel.30.days.spread %>%
  group_by(1) %>%
  summarize(mean.311=mean(`3-1-1`), sd.311=sd(`3-1-1`), #商户未接单系统取消
            mean.312=mean(`3-1-2`), sd.312=sd(`3-1-2`), #商户确认前商户拒单
            mean.322=mean(`3-2-2`), sd.322=sd(`3-2-2`), #运力接单前商户取消
            mean.123=mean(`1-2-3`), sd.123=sd(`1-2-3`)) #运力接单前T内商户取消

# 3-1-1	商户未接单系统取消
diff.yesterday.311 <- abn.shop.cancel.ratio.today.spread[["3-1-1"]] -
  abn.shop.cancel.ratio.yesterday.spread[["3-1-1"]]
diff.avg.311 <- abn.shop.cancel.ratio.today.spread[["3-1-1"]] - 
  abn.shop.cancel.30.days.spread.summary$mean.311
diff.sd.311 <- diff.avg.311 / abn.shop.cancel.30.days.spread.summary$sd.311
# 3-1-2	商户确认前商户拒单
diff.yesterday.312 <- abn.shop.cancel.ratio.today.spread[["3-1-2"]] -
  abn.shop.cancel.ratio.yesterday.spread[["3-1-2"]]
diff.avg.312 <- abn.shop.cancel.ratio.today.spread[["3-1-2"]] - 
  abn.shop.cancel.30.days.spread.summary$mean.312
diff.sd.312 <- diff.avg.312 / abn.shop.cancel.30.days.spread.summary$sd.312
# 3-2-2	运力接单前商户取消
diff.yesterday.322 <- abn.shop.cancel.ratio.today.spread[["3-2-2"]] -
  abn.shop.cancel.ratio.yesterday.spread[["3-2-2"]]
diff.avg.322 <- abn.shop.cancel.ratio.today.spread[["3-2-2"]] - 
  abn.shop.cancel.30.days.spread.summary$mean.322
diff.sd.322 <- diff.avg.322 / abn.shop.cancel.30.days.spread.summary$sd.322
# 1-2-3	运力接单前T内商户取消
diff.yesterday.123 <- abn.shop.cancel.ratio.today.spread[["1-2-3"]] -
  abn.shop.cancel.ratio.yesterday.spread[["1-2-3"]]
diff.avg.123 <- abn.shop.cancel.ratio.today.spread[["1-2-3"]] - 
  abn.shop.cancel.30.days.spread.summary$mean.123
diff.sd.123 <- diff.avg.123 / abn.shop.cancel.30.days.spread.summary$sd.123
```

#### 【商户未接单系统取消】

* 本日订单量 `r prettyNum(abn.shop.cancel.actualcnt.today.spread[["3-1-1"]], big.mark=",")`单，占支付订单量`r round(abn.shop.cancel.ratio.today.spread[["3-1-1"]], 3)`%，比前一天`r decide_up_down(diff.yesterday.311)``r round(abs(diff.yesterday.311), 3)`个百分点，<span style="`r text_color(diff.avg.311, diff.avg.311)`">`r decide_up_down(diff.avg.311, GY_DY)`30天内均值`r round(abs(diff.avg.311), 3)`个百分点(`r round(abs(diff.sd.311), 3)`倍标准差)</span>
* 30天内均值为 `r round(abn.shop.cancel.30.days.spread.summary$mean.311,3)`%，标准差为 `r round(abn.shop.cancel.30.days.spread.summary$sd.311, 3)`%

#### 【商户确认前商户拒单】

* 本日订单量 `r prettyNum(abn.shop.cancel.actualcnt.today.spread[["3-1-2"]], big.mark=",")`单，占支付订单量`r round(abn.shop.cancel.ratio.today.spread[["3-1-2"]], 3)`%，比前一天`r decide_up_down(diff.yesterday.312)``r round(abs(diff.yesterday.312), 3)`个百分点，<span style="`r text_color(diff.avg.312, diff.avg.312)`">`r decide_up_down(diff.avg.312, GY_DY)`30天内均值`r round(abs(diff.avg.312), 3)`个百分点(`r round(abs(diff.sd.312), 3)`倍标准差)</span>
* 30天内均值为 `r round(abn.shop.cancel.30.days.spread.summary$mean.312,3)`%，标准差为 `r round(abn.shop.cancel.30.days.spread.summary$sd.312, 3)`%

#### 【运力接单前商户取消】

* 本日订单量 `r prettyNum(abn.shop.cancel.actualcnt.today.spread[["3-2-2"]], big.mark=",")`单，占支付订单量`r round(abn.shop.cancel.ratio.today.spread[["3-2-2"]], 3)`%，比前一天`r decide_up_down(diff.yesterday.322)``r round(abs(diff.yesterday.322), 3)`个百分点，<span style="`r text_color(diff.avg.322, diff.avg.322)`">`r decide_up_down(diff.avg.322, GY_DY)`30天内均值`r round(abs(diff.avg.322), 3)`个百分点(`r round(abs(diff.sd.322), 3)`倍标准差)</span>
* 30天内均值为 `r round(abn.shop.cancel.30.days.spread.summary$mean.322,3)`%，标准差为 `r round(abn.shop.cancel.30.days.spread.summary$sd.322, 3)`%

#### 【运力接单前T内商户取消】

* 本日订单量 `r prettyNum(abn.shop.cancel.actualcnt.today.spread[["1-2-3"]], big.mark=",")`单，占支付订单量`r round(abn.shop.cancel.ratio.today.spread[["1-2-3"]], 3)`%，比前一天`r decide_up_down(diff.yesterday.123)``r round(abs(diff.yesterday.123), 3)`个百分点，<span style="`r text_color(diff.avg.123, diff.avg.123)`">`r decide_up_down(diff.avg.123, GY_DY)`30天内均值`r round(abs(diff.avg.123), 3)`个百分点(`r round(abs(diff.sd.123), 3)`倍标准差)</span>
* 30天内均值为 `r round(abn.shop.cancel.30.days.spread.summary$mean.123,3)`%，标准差为 `r round(abn.shop.cancel.30.days.spread.summary$sd.123, 3)`%

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.height=4,fig.width=8}
abn.shop.cancel.rate <- abn.shop.cancel.rate %>% mutate(ratio_payed=ratio_payed/100)
p2 <- ggplot(abn.shop.cancel.rate, aes(x=order_date,y=ratio_payed)) +
  geom_line(aes(y = ratio_payed, colour = respb_scene_name)) +
  theme(text = element_text('SimSun'),
        legend.position = "bottom",
        legend.title=element_blank()) +
  scale_y_continuous(trans="log10", breaks = base_breaks(), labels=function(x){percent(x,digits=3)}) +
  labs(x = "日期", y = "百分率") +
  scale_x_date(breaks = pretty_breaks(15), labels = date_format("%m/%d")) + 
  ggtitle(paste("订单商户取消率变化趋势", date_range))
p2 <- plotly_build(p2)
p2$x$data[[1]]$text <-
  apply(abn.shop.cancel.rate %>% filter(respb_scene_name == "商户未接单系统取消"), 1,
        function(item){
         paste0(date_desc(item[1]), item[1], "<br>商户未接单系统取消: ", percent(as.double(item[7]),3))
          }
        )
p2$x$data[[2]]$text <-
  apply(abn.shop.cancel.rate %>% filter(respb_scene_name == "商户确认前商户拒单"), 1,
        function(item){
         paste0(date_desc(item[1]), item[1], "<br>商户确认前商户拒单: ", percent(as.double(item[7]),3))
          }
        )
p2$x$data[[3]]$text <-
  apply(abn.shop.cancel.rate %>% filter(respb_scene_name == "运力接单前商户取消"), 1,
        function(item){
         paste0(date_desc(item[1]), item[1], "<br>运力接单前商户取消: ", percent(as.double(item[7]),3))
          }
        )
p2$x$data[[4]]$text <-
  apply(abn.shop.cancel.rate %>% filter(respb_scene_name == "运力接单前T内商户取消"), 1,
        function(item){
         paste0(date_desc(item[1]), item[1], "<br>运力接单前T内商户取消: ", percent(as.double(item[7]),3))
          }
        )
p2
```


```{r echo=FALSE}
### 细分场景异常摘要数据 (calculate and save)
#list("订单取消_运单异常"="abn1",
#     "订单取消_运单正常"="abn1-ydnorm",
#     "订单正常_运单异常"="abn2",
#     "订单正常_运单超时"="abn2-chaoshi",
#     "订单取消_无运单"="abn3")

today_detail <- abn_daily %>%
  filter(startsWith(as.character(abn), "abn") & abn != "abnormal"
         & order_date == today & respb_scene != "_汇总")
today_detail <- today_detail[with(today_detail, order(abn, -actualcnt)), ]

today_abn1_detail <- today_detail %>%
  filter(abn == "abn1") %>%
  mutate(percent=actualcnt/sum(actualcnt), cum_percent=cumsum(actualcnt)/sum(actualcnt))


today_abn1_detail <- today_detail %>%
  filter(abn == "abn1" & respb_scene != "_汇总") %>%
  mutate(percent=actualcnt/sum(actualcnt), cum_percent=cumsum(actualcnt)/sum(actualcnt))
today_abn1.ydnorm_detail <- today_detail %>%
  filter(abn == "abn1-ydnorm") %>%
  mutate(percent=actualcnt/sum(actualcnt), cum_percent=cumsum(actualcnt)/sum(actualcnt))
today_abn2_detail <- today_detail %>%
  filter(abn == "abn2") %>%
  mutate(percent=actualcnt/sum(actualcnt), cum_percent=cumsum(actualcnt)/sum(actualcnt))
today_abn2.chaoshi_detail <- today_detail %>%
  filter(abn == "abn2-chaoshi") %>%
  mutate(percent=actualcnt/sum(actualcnt), cum_percent=cumsum(actualcnt)/sum(actualcnt))
today_abn3_detail <- today_detail %>%
  filter(abn == "abn3") %>%
  mutate(percent=actualcnt/sum(actualcnt), cum_percent=cumsum(actualcnt)/sum(actualcnt))

save(today_abn1_detail,
     today_abn1.ydnorm_detail,
     today_abn2_detail,
     today_abn2.chaoshi_detail,
     today_abn3_detail,
     abn_daily,
     start_date,
     yesterday,
     abn.today,
     today_overall,
     file=paste0("cached/detail.", params$rpt_date, ".rda")
     )
```

