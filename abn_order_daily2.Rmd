---
title: "异常交易监控日报"
output:
  html_document:
    css: style.css
  pdf_document:
    latex_engine: xelatex
  word_document: default
---

```{r echo=FALSE, warning=FALSE, message=FALSE}
setwd("~/projects/abn_order2/")

# import pacakges
library(ggplot2)
library(scales)
library(gtable)
library(grid)
library(dplyr)
library(tidyr)
library(xlsx)
#library(extrafont)
#font_import(paths="~/Downloads/", prompt=FALSE, pattern="Sim")

# fixed value
ZJ_XJ <- c("增加", "下降")
GY_DY <- c("高于", "低于")

# udf
## format decimal to percentage
percent <- function(x, digits = 2, format = "f", ...) {
  paste0(formatC(100 * x, format = format, digits = digits, ...), "%")
}
## decide color of some text
text_color <- function(diff.val, diff.sd) {
  if (abs(diff.sd) < 2) {""}
  else {ifelse(diff.val > 0, "color:green", "color:red")}
}

## decide up or down
decide_up_down <- function(diff.val, updown=ZJ_XJ) {
  ifelse(diff.val >= 0, updown[1], updown[2])
}

# read data
#abn_daily <- read.xlsx("data/0126-all.xlsx", 1)
#abn_daily <- abn_daily %>%
#  mutate(order_date=as.Date(order_date))
load("abn_daily.rda")

# some special date
today <- max(abn_daily$order_date)
yesterday <- today -1
start_date <- today - 30
date_range <- paste0("(", format(min(abn_daily$order_date), "%m%d"),
                 "-", format(max(abn_daily$order_date), "%m%d"), ")")
```

## 总订单量背景趋势

```{r echo=FALSE, warning=FALSE, message=FALSE}
abn.30days <- abn_daily %>%
  filter(order_date > start_date & abn %in% c("abnormal", "bookord", "payed", "created")) %>%
  select(order_date, abn, actualcnt)
 
abn.30days.spread <- spread(abn.30days, abn, actualcnt) %>%
  mutate(payed_rate=payed/created, payed_rate=payed/created, book_rate=bookord/payed, abn_rate=abnormal/payed)

abn.30days.summary <- abn.30days.spread %>%
  select(order_date, created, payed_rate, book_rate, abn_rate) %>%
  group_by(1) %>%
  summarize(mean.created=mean(created), sd.created=sd(created),
            mean.payed.rate=mean(payed_rate), sd.payed.rate=sd(payed_rate),
            mean.book.rate=mean(book_rate), sd.book.rate=sd(book_rate),
            mean.abn.rate=mean(abn_rate), sd.abn.rate=sd(abn_rate))
abn.today <- abn.30days.spread %>% filter(order_date == today)
abn.yesterday <- abn.30days.spread %>% filter(order_date == yesterday)

# 创建订单量
created.diff.yesterday <- abn.today$created - abn.yesterday$created
created.diff.avg <- abn.today$created - abn.30days.summary$mean.created
created.diff.sd <- created.diff.avg / abn.30days.summary$sd.created
# 支付订单量
payed_rate.diff.yesterday <- abn.today$payed_rate-abn.yesterday$payed_rate
payed_rate.diff.avg <- abn.today$payed_rate-abn.30days.summary$mean.payed.rate
payed_rate.diff.sd <- payed_rate.diff.avg/abn.30days.summary$sd.payed.rate
# 预定单
book_rate.diff.yesterday <- abn.today$book_rate - abn.yesterday$book_rate
book_rate.diff.avg <- abn.today$book_rate - abn.30days.summary$mean.book.rate
book_rate.diff.sd <- book_rate.diff.avg / abn.30days.summary$sd.book.rate
# 异常订单
abn_rate.diff.yesterday <- abn.today$abn_rate - abn.yesterday$abn_rate
abn_rate.diff.avg <- abn.today$abn_rate-abn.30days.summary$mean.abn.rate
abn_rate.diff.sd <- abn_rate.diff.avg/abn.30days.summary$sd.abn.rate
```

* 【创建订单量】今日订单量 `r prettyNum(abn.today$created, big.mark=",")` 单，比前一天`r decide_up_down(created.diff.yesterday)` `r prettyNum(abs(created.diff.yesterday), big.mark=",")`单，<span style="`r text_color(created.diff.avg, created.diff.sd)`">`r decide_up_down(created.diff.avg, GY_DY)`30天内均值`r prettyNum(abs(created.diff.avg), big.mark=",")`
单(`r round(abs(created.diff.sd), 1)`倍标准差)</span>。30天内均值为 `r prettyNum(abn.30days.summary$mean.created, big.mark=",")` ，标准差为 `r prettyNum(round(abn.30days.summary$sd.created), big.mark=",")`。
* 【支付订单量】今日订单量 `r prettyNum(abn.today$payed, big.mark=",")` 单，占支付订单量`r percent(abn.today$payed_rate ,digits=1)`，比前一天`r decide_up_down(payed_rate.diff.yesterday)``r round((abs(payed_rate.diff.yesterday)) * 100, 2)`个百分 点，<span style="`r text_color(payed_rate.diff.avg, payed_rate.diff.sd)`">`r decide_up_down(payed_rate.diff.avg, GY_DY)`30天内均值`r round((abs(payed_rate.diff.avg))*100, 1)`个百分点(`r round(abs(payed_rate.diff.sd), 2)`倍标准差)</span>。30天内均值为 `r percent(abn.30days.summary$mean.payed.rate)`，标准差为 `r percent(abn.30days.summary$sd.payed.rate)`
* 【预定单】今日订单量 `r prettyNum(abn.today$bookord, big.mark=",")` 单，占支付订单量`r percent(abn.today$book_rate)`，比前一天`r decide_up_down(book_rate.diff.yesterday)``r round(abs(book_rate.diff.yesterday*100), 2)`个百分点，<span style="`r text_color(book_rate.diff.avg, book_rate.diff.sd)`">`r decide_up_down(book_rate.diff.avg, GY_DY)`30天内均值`r round((abs(book_rate.diff.avg))*100, 2)`个百分点(`r round(abs(book_rate.diff.sd), 2)`倍标准差)</span>。30天内均值为 `r percent(abn.30days.summary$mean.book.rate)`，标准差为 `r percent(abn.30days.summary$sd.book.rate)`
* 【异常订单】今日订单量 `r prettyNum(abn.today$abnormal, big.mark=",")`单，占支付订单量`r percent(abn.today$abn_rate)`，比前一天`r decide_up_down(abn_rate.diff.yesterday)``r round(abs(abn_rate.diff.yesterday)*100, digits=2)`个百分 点，<span style="`r text_color(abn_rate.diff.avg, abn_rate.diff.sd)`">`r decide_up_down(abn_rate.diff.avg, GY_DY)`30天内均值`r round((abn_rate.diff.avg)*100,2)`个百分点(`r round(abs(abn_rate.diff.sd), 1)`倍标准差)</span>。30天内均值为 `r percent(abn.30days.summary$mean.abn.rate)`，标准差为 `r percent(abn.30days.summary$sd.abn.rate)`

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.height=3}
today_overall <- subset(abn_daily, order_date==today & respb_scene == "_汇总")
today_overall$abn <- droplevels(today_overall$abn) # remove unused levels

levels(today_overall$abn) <- list("订单取消_运单异常"="abn1",
                                    "订单取消_运单正常"="abn1-ydnorm",
                                    "订单正常_运单异常"="abn2",
                                    "订单正常_运单超时"="abn2-chaoshi",
                                    "订单取消_无运单"="abn3")
today_overall$percent <- today_overall$actualcnt / sum(today_overall$actualcnt)
bp<- ggplot(today_overall, aes(x="", y=percent, fill=abn)) +
  geom_bar(width = 1, stat = "identity") +
  theme(text = element_text(family = 'SimSun'),
        axis.ticks=element_blank()) +
  ggtitle("异常订单占比") +
  guides(fill=guide_legend(title=NULL)) +
  labs(x="", y="")
pie <- bp + coord_polar("y", start=0)
midpoint <- cumsum(rev(today_overall$percent)) - rev(today_overall$percent)/2
pie <- pie + scale_y_continuous(breaks=midpoint, labels=percent(rev(today_overall$percent), digits=1))
pie + theme(panel.background = element_blank())
```


```{r echo=FALSE, warning=FALSE, message=FALSE, fig.height=4, fig.width=8}
abn_ratio <- abn_daily %>%
  filter(respb_scene == "_汇总") %>%
  group_by(order_date) %>%
  summarize(abn_ratio=sum(cnt))

abn_payed_ratio <- abn_daily %>%
  filter(abn=="payed") %>%
  select(order_date, ratio_payed)

abn_created_cnt <- abn_daily %>%
  filter(abn=="created") %>%
  select(order_date, cnt)

temp <-merge(x=abn_ratio, y=abn_payed_ratio)
abn_overall <- merge(x=temp, y=abn_created_cnt)

abn_overall <- abn_overall %>%
  mutate(abn_cnt=abn_ratio*cnt*ratio_payed/10000,
         order_date=as.Date(order_date))

abn_total_cnt <- abn_overall %>%
  mutate(type="created") %>%
  mutate(value=cnt) %>%
  select(order_date, value, type)

abn_cnt <- abn_overall %>%
  mutate(value=abn_cnt) %>%
  mutate(type="abn") %>%
  select(order_date, value, type)

abn_total_abn_cnt <- rbind(abn_total_cnt, abn_cnt)
abn_total_abn_cnt$type <- as.factor(abn_total_abn_cnt$type)
levels(abn_total_abn_cnt$type) <- list("总异常订单量"="abn", "创建订单量"="created")
p1 <- ggplot(abn_total_abn_cnt, aes(x=order_date, y=value)) +
  geom_area(alpha = 0.7, position = 'identity', aes(fill = type)) +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "bottom",
        legend.title = element_blank(),
        text = element_text('SimSun')) +
  labs(x = "日期", y = "数量") +
  scale_y_continuous(labels = comma) +
  scale_x_date(breaks = pretty_breaks(15), labels = date_format("%m/%d")) +
  ggtitle(paste("总异常订单量（率）趋势", date_range))

max_y <- ceiling(max(abn_overall$abn_ratio) * 1.15)
p2 <- ggplot(abn_overall, aes(x=order_date)) + geom_line(aes(y = abn_ratio, colour = "总异常率")) + theme(text = element_text(family = 'SimSun')) + scale_linetype(NULL) + scale_colour_brewer(palette = "Set1") + theme(legend.title = element_blank(), text = element_text('SimSun'), legend.position = "bottom", panel.grid.major= element_blank(), panel.grid.minor = element_blank())%+replace% theme(panel.background = element_rect(fill = NA)) + ylim(0, max_y)

g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t, 
                       pp$l, pp$b, pp$l)
  
# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
  
# combind legends
leg1 <- g1$grobs[[which(g1$layout$name == "guide-box")]]
leg2 <- g2$grobs[[which(g2$layout$name == "guide-box")]]
  
g$grobs[[which(g$layout$name == "guide-box")]] <- gtable:::cbind_gtable(leg1, leg2, "first")
grid::grid.draw(g)
```

## 异常摘要

```{r echo=FALSE, warning=FALSE, message=FALSE}
abn.30days.detail <- abn_daily %>%
  filter(order_date > start_date & respb_scene == "_汇总") %>%
  select(order_date, abn, cnt)

abn.30days.detail.spread <- spread(abn.30days.detail, abn, cnt)
abn.30days.detail.summary <- abn.30days.detail.spread %>%
  group_by(1) %>%
  summarize(mean.abn1=mean(abn1), sd.abn1=sd(abn1),
            mean.abn1_ydnorm=mean(`abn1-ydnorm`), sd.abn1_ydnorm=sd(`abn1-ydnorm`),
            mean.abn2=mean(abn2), sd.abn2=sd(abn2),
            mean.abn2_chaoshi=mean(`abn2-chaoshi`), sd.abn2_chaoshi=sd(`abn2-chaoshi`),
            mean.abn3=mean(abn3), sd.abn3=sd(abn3))

abn.today.detail.actualcnt <- abn_daily %>%
  filter(order_date == today & respb_scene == "_汇总") %>%
  select(abn, actualcnt)
abn.today.detail.actualcnt.spread <- spread(abn.today.detail.actualcnt, abn, actualcnt)

abn.today.detail.cnt <- abn_daily %>%
  filter(order_date == today & respb_scene == "_汇总") %>%
  select(abn, cnt)
abn.today.detail.cnt.spread <- spread(abn.today.detail.cnt, abn, cnt)

abn.yesterday.detail.actualcnt <- abn_daily %>%
  filter(order_date == yesterday & respb_scene == "_汇总") %>%
  select(abn, actualcnt)
abn.yesterday.detail.actualcnt.spread <- spread(abn.yesterday.detail.actualcnt, abn, actualcnt)

abn.yesterday.detail.cnt <- abn_daily %>%
  filter(order_date == yesterday & respb_scene == "_汇总") %>%
  select(abn, cnt)
abn.yesterday.detail.cnt.spread <- spread(abn.yesterday.detail.cnt, abn, cnt)

# 订单正常运单超时 (abn2-chaoshi)
abn2.chaoshi.diff.yesterday <- abn.today.detail.cnt.spread[["abn2-chaoshi"]] - abn.yesterday.detail.cnt.spread[["abn2-chaoshi"]]
abn2.chaoshi.diff.avg <- abn.today.detail.cnt.spread[["abn2-chaoshi"]] - abn.30days.detail.summary$mean.abn2_chaoshi
abn2.chaoshi.diff.sd <- abn2.chaoshi.diff.avg / abn.30days.detail.summary$sd.abn2_chaoshi

# 订单正常运单异常 (abn2)
abn2.diff.yesterday <- abn.today.detail.cnt.spread[["abn2"]] - abn.yesterday.detail.cnt.spread[["abn2"]]
abn2.diff.avg <- abn.today.detail.cnt.spread[["abn2"]] - abn.30days.detail.summary$mean.abn2
abn2.diff.sd <- abn2.diff.avg / abn.30days.detail.summary$sd.abn2

# 订单取消无运单 (abn3)
abn3.diff.yesterday <- abn.today.detail.cnt.spread[["abn3"]] - abn.yesterday.detail.cnt.spread[["abn3"]]
abn3.diff.avg <- abn.today.detail.cnt.spread[["abn3"]] - abn.30days.detail.summary$mean.abn3
abn3.diff.sd <- abn3.diff.avg / abn.30days.detail.summary$sd.abn3

# 订单取消运单异常 (abn1)
abn1.diff.yesterday <- abn.today.detail.cnt.spread[["abn1"]] - abn.yesterday.detail.cnt.spread[["abn1"]]
abn1.diff.avg <- abn.today.detail.cnt.spread[["abn1"]] - abn.30days.detail.summary$mean.abn1
abn1.diff.sd <- abn1.diff.avg / abn.30days.detail.summary$sd.abn1

# 订单取消运单正常 (abn1-ydnorm)
abn1.ydnorm.diff.yesterday <- abn.today.detail.cnt.spread[["abn1-ydnorm"]] - abn.yesterday.detail.cnt.spread[["abn1-ydnorm"]]
abn1.ydnorm.diff.avg <- abn.today.detail.cnt.spread[["abn1-ydnorm"]] - abn.30days.detail.summary$mean.abn1_ydnorm
abn1.ydnorm.diff.sd <- abn1.ydnorm.diff.avg / abn.30days.detail.summary$sd.abn1_ydnorm
```

* 【订单正常运单超时】:今日订单量 `r prettyNum(abn.today.detail.actualcnt.spread[["abn2-chaoshi"]], big.mark=",")`单，占支付订单量`r round(abn.today.detail.cnt.spread[["abn2-chaoshi"]], 2)`%，比前一天`r decide_up_down(abn2.chaoshi.diff.yesterday)``r round(abs(abn2.chaoshi.diff.yesterday), 2)`个百分点，<span style="`r text_color(abn2.chaoshi.diff.avg, abn2.chaoshi.diff.sd)`">`r decide_up_down(abn2.chaoshi.diff.avg, GY_DY)`30天内均值`r round(abs(abn2.chaoshi.diff.avg), 2)`个百分点(`r round(abs(abn2.chaoshi.diff.sd), 1)`倍标准差)</span>。30天内均值为 `r round(abn.30days.detail.summary$mean.abn2_chaoshi,2)`%，标准差为 `r round(abn.30days.detail.summary$sd.abn2_chaoshi, 2)`%
* 【订单正常运单异常】:今日订单量 `r prettyNum(abn.today.detail.actualcnt.spread[["abn2"]], big.mark=",")`单，占支付订单量`r round(abn.today.detail.cnt.spread[["abn2"]], 2)`%，比前一天`r decide_up_down(abn2.diff.yesterday)``r round(abs(abn2.diff.yesterday), 2)`个百分点，<span style="`r text_color(abn2.diff.avg, abn2.diff.sd)`">`r decide_up_down(abn2.diff.avg, GY_DY)`30天内均值`r round(abs(abn2.diff.avg), 2)`个百分点(`r round(abs(abn2.diff.sd), 1)`倍标准差)</span>。30天内均值为 `r round(abn.30days.detail.summary$mean.abn2,2)`%，标准差为 `r round(abn.30days.detail.summary$sd.abn2, 2)`%
* 【订单取消无运单】:今日订单量 `r prettyNum(abn.today.detail.actualcnt.spread[["abn3"]], big.mark=",")`单，占支付订单量`r round(abn.today.detail.cnt.spread[["abn3"]], 2)`%，比前一天`r decide_up_down(abn3.diff.yesterday)``r round(abs(abn3.diff.yesterday), 2)`个百分点，<span style="`r text_color(abn3.diff.avg, abn3.diff.sd)`">`r decide_up_down(abn3.diff.avg, GY_DY)`30天内均值`r round(abs(abn3.diff.avg), 2)`个百分点(`r round(abs(abn3.diff.sd), 1)`倍标准差)</span>。30天内均值为 `r round(abn.30days.detail.summary$mean.abn3,2)`%，标准差为 `r round(abn.30days.detail.summary$sd.abn3, 2)`%
* 【订单取消运单异常】:今日订单量 `r prettyNum(abn.today.detail.actualcnt.spread[["abn1"]], big.mark=",")`单，占支付订单量`r round(abn.today.detail.cnt.spread[["abn1"]], 2)`%，比前一天`r decide_up_down(abn1.diff.yesterday)``r round(abs(abn1.diff.yesterday), 2)`个百分点，<span style="`r text_color(abn1.diff.avg, abn1.diff.sd)`">`r decide_up_down(abn1.diff.avg, GY_DY)`30天内均值`r round(abs(abn1.diff.avg), 2)`个百分点(`r round(abs(abn1.diff.sd), 1)`倍标准差)</span>。30天内均值为 `r round(abn.30days.detail.summary$mean.abn1,2)`%，标准差为 `r round(abn.30days.detail.summary$sd.abn1, 2)`%
* 【订单取消运单正常】:今日订单量 `r prettyNum(abn.today.detail.actualcnt.spread[["abn1-ydnorm"]], big.mark=",")`单，占支付订单量`r round(abn.today.detail.cnt.spread[["abn1-ydnorm"]], 2)`%，比前一天`r decide_up_down(abn1.ydnorm.diff.yesterday)``r round(abs(abn1.ydnorm.diff.yesterday), 2)`个百分点，<span style="`r text_color(abn1.ydnorm.diff.avg, abn1.ydnorm.diff.sd)`">`r decide_up_down(abn1.ydnorm.diff.avg, GY_DY)`30天内均值`r round(abs(abn1.ydnorm.diff.avg), 3)`个百分点(`r round(abs(abn1.ydnorm.diff.sd), 1)`倍标准差)</span>。30天内均值为 `r round(abn.30days.detail.summary$mean.abn1_ydnorm,2)`%，标准差为 `r round(abn.30days.detail.summary$sd.abn1_ydnorm, 2)`%

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.width=8}

# plot 1
p1 <- ggplot(subset(abn_daily, abn=="created"), aes(x=order_date, y=cnt)) +
  geom_area(alpha = 0.4, position = 'identity', aes(fill = "创建订单量")) + theme(axis.text.x = element_text(angle = 90), legend.position = "bottom", legend.title = element_blank(), text = element_text('SimSun'), legend.text=element_text(size=8), plot.margin=unit(c(1,1.2,1.2,1.2),"cm")) + labs(x = "日期", y = "数量") + scale_y_continuous(labels = comma) + scale_x_date(breaks = pretty_breaks(15), labels = date_format("%m/%d"))

# plot2
abn_rate <- abn_daily %>%
  filter(respb_scene == "_汇总" | abn=="payed") %>%
  mutate(value=ratio_payed)

rate100 <- abn_rate %>%
  filter(abn == "abn1-ydnorm") %>%
  mutate(value=ratio_payed*100)
rate0.1 <- abn_rate %>%
  filter(abn == "payed") %>%
  mutate(value=ratio_payed/10)
rate1 <- abn_rate %>%
  filter(abn != "abn1-ydnorm" & abn != "payed") %>%
  mutate(value=ratio_payed)

abn_scaled_rate <- rbind(rate100, rate0.1, rate1)
abn_scaled_rate$abn <- droplevels(abn_scaled_rate$abn) # remove unused levels
levels(abn_scaled_rate$abn) <- list("订单取消_运单异常"="abn1",
                                    "订单取消_运单正常*100"="abn1-ydnorm",
                                    "订单正常_运单异常"="abn2",
                                    "订单正常_运单超时"="abn2-chaoshi",
                                    "订单取消_无运单"="abn3",
                                    "支付成功率/10"="payed")
  
p2 <- ggplot(abn_scaled_rate, aes(x=order_date,y=value)) +
  geom_line(aes(y = value, colour = abn)) +
  scale_linetype(NULL) +
  scale_colour_brewer(palette = "Set1") +
  theme(legend.title = element_blank(), text = element_text('SimSun'),
        legend.text=element_text(size=8),
        legend.position = "bottom", panel.grid.major= element_blank(),
        panel.grid.minor = element_blank()) %+replace% 
  theme(panel.background = element_rect(fill = NA),
        plot.margin=unit(c(1,1.2,1.2,1.2),"cm"))
  
# combine 2 plots
g1 <- ggplot_gtable(ggplot_build(p1 + ggtitle(paste("异常订单率变化趋势", date_range))))
g2 <- ggplot_gtable(ggplot_build(p2))
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t, 
                       pp$l, pp$b, pp$l)
  
# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
  
## combind legends
leg1 <- g1$grobs[[which(g1$layout$name == "guide-box")]]
leg2 <- g2$grobs[[which(g2$layout$name == "guide-box")]]
  
g$grobs[[which(g$layout$name == "guide-box")]] <- gtable:::cbind_gtable(leg1, leg2, "first")
grid::grid.draw(g)
```

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.width=8}
# 商户取消率变化趋势
# plot2
abn.cancel.rate <- abn_daily %>%
  filter(respb_scene %in% c("3-2-2", "3-1-1", "3-1-2") | (abn == "abn1" & respb_scene == "1-2-3")) %>%
  mutate(cancel_type=as.factor(paste(abn, respb_scene, sep=","))) %>%
  select(order_date, abn, cancel_type, ratio_payed) 

cancel.rate1 <- abn.cancel.rate %>%
  filter(abn != "abn1") %>%
  mutate(value=ratio_payed) %>%
  select(order_date, cancel_type, value)
cancel.rate10 <- abn.cancel.rate %>%
  filter(abn == "abn1") %>%
  mutate(value=ratio_payed * 10) %>%
  select(order_date, cancel_type, value)

abn.cancel.rate <- rbind(cancel.rate1, cancel.rate10)
levels(abn.cancel.rate$cancel_type) <- list("运单接单前T 之内商户取消*10"="abn1,1-2-3",
                                    "商户未接单被系统取消"="abn3,3-1-1",
                                    "商户拒单"="abn3,3-1-2",
                                    "商户确认订单后，运力接单前__取消订单"="abn3,3-2-2")
p2 <- ggplot(abn.cancel.rate, aes(x=order_date,y=value)) +
  geom_line(aes(y = value, colour = cancel_type)) +
  scale_linetype(NULL) +
  scale_colour_brewer(palette = "Set1") +
  theme(legend.title = element_blank(),
        text = element_text('SimSun'),
        legend.position = "bottom",
        panel.grid.major= element_blank(),
        panel.grid.minor = element_blank(),
        legend.text=element_text(size=8)) %+replace%
  theme(panel.background = element_rect(fill = NA))

# combine 2 plots
g1 <- ggplot_gtable(ggplot_build(p1 + ggtitle(paste("商户取消率变化趋势", date_range))))
g2 <- ggplot_gtable(ggplot_build(p2))
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t, 
                       pp$l, pp$b, pp$l)
  
# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
  
## combind legends
leg1 <- g1$grobs[[which(g1$layout$name == "guide-box")]]
leg2 <- g2$grobs[[which(g2$layout$name == "guide-box")]]
  
g$grobs[[which(g$layout$name == "guide-box")]] <- gtable:::cbind_gtable(leg1, leg2, "first")
grid::grid.draw(g)
```

### 细分场景异常摘要

```{r echo=FALSE}
#list("订单取消_运单异常"="abn1",
#     "订单取消_运单正常"="abn1-ydnorm",
#     "订单正常_运单异常"="abn2",
#     "订单正常_运单超时"="abn2-chaoshi",
#     "订单取消_无运单"="abn3")

today_detail <- abn_daily %>%
  filter(startsWith(as.character(abn), "abn") & abn != "abnormal"
         & order_date == today & respb_scene != "_汇总")
today_detail <- today_detail[with(today_detail, order(abn, -actualcnt)), ]

today_abn1_detail <- today_detail %>%
  filter(abn == "abn1") %>%
  mutate(percent=actualcnt/sum(actualcnt), cum_percent=cumsum(actualcnt)/sum(actualcnt))


today_abn1_detail <- today_detail %>%
  filter(abn == "abn1" & respb_scene != "_汇总") %>%
  mutate(percent=actualcnt/sum(actualcnt), cum_percent=cumsum(actualcnt)/sum(actualcnt))
today_abn1.ydnorm_detail <- today_detail %>%
  filter(abn == "abn1-ydnorm") %>%
  mutate(percent=actualcnt/sum(actualcnt), cum_percent=cumsum(actualcnt)/sum(actualcnt))
today_abn2_detail <- today_detail %>%
  filter(abn == "abn2") %>%
  mutate(percent=actualcnt/sum(actualcnt), cum_percent=cumsum(actualcnt)/sum(actualcnt))
today_abn2.chaoshi_detail <- today_detail %>%
  filter(abn == "abn2-chaoshi") %>%
  mutate(percent=actualcnt/sum(actualcnt), cum_percent=cumsum(actualcnt)/sum(actualcnt))
today_abn3_detail <- today_detail %>%
  filter(abn == "abn3") %>%
  mutate(percent=actualcnt/sum(actualcnt), cum_percent=cumsum(actualcnt)/sum(actualcnt))

more_detailed_rpt <- function(today_detail) {
  for (i in 1:nrow(today_detail)){
    row_data <- today_detail[i, ]
    ratio_payed.30days <- abn_daily %>%
      filter(order_date > start_date, abn == row_data$abn, respb_scene == row_data$respb_scene) %>%
      select(order_date, ratio_payed)
  
    ratio_payed.30days.summary <- ratio_payed.30days %>% 
      group_by(1) %>%
      summarise(mean.ratio_payed=mean(ratio_payed), sd.ratio_payed=sd(ratio_payed))
    diff.yesterday <- row_data$ratio_payed - subset(ratio_payed.30days, order_date == yesterday)$ratio_payed
    diff.mean <- row_data$ratio_payed - ratio_payed.30days.summary$mean.ratio_payed
    diff.sd <- abs(diff.mean / ratio_payed.30days.summary$sd.ratio_payed)
  
    cat("* 【",
        as.character(row_data$respb_scene_name),
        "】今日订单量",
        prettyNum(row_data$actualcnt, big.mark=","),
        "单，占支付订单量",
        round(row_data$ratio_payed, 3),
        "%，比前一天",
        decide_up_down(diff.yesterday),
        abs(round(diff.yesterday, 3)),
        "个百分点，",
        decide_up_down(diff.mean, GY_DY),
        "30天内均值",
        round(diff.mean, 3),
        "个百分点（",
        round(diff.sd, 1),
        "倍标准差）。30天内均值为",
        round(ratio_payed.30days.summary$mean.ratio_payed, 3),
        "%，标准差为",
        round(ratio_payed.30days.summary$sd.ratio_payed, 3),
        "%\n",
        sep="")
  }
}
```

#### 【订单取消运单异常】

```{r, results='asis', echo=FALSE}
more_detailed_rpt(today_abn1_detail)
```


#### 【订单正常运单超时】

```{r, results='asis', echo=FALSE}
more_detailed_rpt(today_abn1.ydnorm_detail)
```

#### 【订单正常运单异常】

```{r, results='asis', echo=FALSE}
more_detailed_rpt(today_abn2_detail)
```

#### 【订单取消无运单】

```{r, results='asis', echo=FALSE}
more_detailed_rpt(today_abn2.chaoshi_detail)
```

